#!/bin/bash

set -e -E -u -o pipefail -o noclobber -o noglob +o braceexpand || exit -- 1
trap 'printf -- "[ee] failed: %s\n" "${BASH_COMMAND}" >&2' ERR || exit -- 1
test "${#}" -eq 0
export -- LC_ALL=C


if test -e ./.x-run.options -a ./.x-run.options -nt ./.x-run ; then
	exec -- cat -- ./.x-run.options
	exit -- 1
else
	exec {_stdout_fd}<&1
	exec >| ./.x-run.options.tmp1
fi




cat <<'EOS'




:: compile / all / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --no-default-features --features vonuvoli_debug "${@}"
:: compile / all / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --release "${@}"

:: compile / lib / debug :: x-run ':: compile / peg' ; x-run ':: compile / lib / sources-include' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --lib --no-default-features --features vonuvoli_debug "${@}"
:: compile / lib / release :: x-run ':: compile / peg' ; x-run ':: compile / lib / sources-include' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --lib --release "${@}"

:: compile / bin / interpreter / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-interpreter --no-default-features --features vonuvoli_debug "${@}"
:: compile / bin / interpreter / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-interpreter --release "${@}"

:: compile / bin / compiler / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-compiler --no-default-features --features vonuvoli_debug "${@}"
:: compile / bin / compiler / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-compiler --release "${@}"

:: compile / bin / tester / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-tester --no-default-features --features vonuvoli_debug "${@}"
:: compile / bin / tester / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-tester --release "${@}"

:: compile / bin / bencher / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-bencher --no-default-features --features vonuvoli_debug "${@}"
:: compile / bin / bencher / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --bin vonuvoli-scheme-bencher --release "${@}"

:: compile / test / all / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --no-default-features --features vonuvoli_debug --no-run "${@}"
:: compile / test / all / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --release --no-run "${@}"

:: compile / doc / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo doc --quiet --no-default-features --features vonuvoli_debug --no-deps "${@}"
:: compile / doc / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo doc --quiet --release --no-deps "${@}"

:: compile / clean :: exec -- find ./target/ -mindepth 1 -xdev -depth -print -delete

:: compile / documentation / readme / restview :: exec -- ./.python/bin/restview -B -l 53110 -- ./readme.rst
:: compile / documentation / r7rs-support :: exec -- x-run ':: execute / test / low-level-r7rs / tests / all / debug' 2>| ./documentation/r7rs-support.md




<< compile / peg
	test "${#}" -eq 0
	export -- PATH="${RUST_PATH}"
	if test ./sources/parser_peg.peg -nt ./sources/parser_peg.rs ; then
		# printf -- '== compile / peg ==\n' >&2
		if test -e ./sources/parser_peg.rs ; then
			rm -- ./sources/parser_peg.rs
		fi
		rust-peg < ./sources/parser_peg.peg >| ./sources/.parser_peg.rs.tmp1
		rustfmt --force < ./sources/.parser_peg.rs.tmp1 >| ./sources/.parser_peg.rs.tmp2 && _outcome=0 || _outcome="${?}"
		if test "${_outcome}" -ne 3 ; then
			exit -- "${_outcome}"
		fi
		mv -T -- ./sources/.parser_peg.rs.tmp2 ./sources/parser_peg.rs
		rm -- ./sources/.parser_peg.rs.tmp1
	fi
!!

<< compile / lib / sources-include
	test "${#}" -eq 0
	export -- PATH="${RUST_PATH}"
	if test -e ./target/lib_sources.in ; then
		_timestamp_previous="$( exec -- date --reference ./target/lib_sources.in -- '+%s' )"
	else
		_timestamp_previous=0
	fi
	_timestamp_current="$( find ./sources/ -xdev -type f -not -name '.*' -not -name 'lib_sources.in' \( -name '*.rs' -o -name '*.in' \) -printf '%T@\n' | LC_ALL=C sort | tail -n 1 )"
	_timestamp_current="${_timestamp_current%%.*}"
	if test "${_timestamp_previous}" -lt "${_timestamp_current}" ; then
		# printf -- '== compile / lib / sources-include ==\n' >&2
		if test -e ./target/lib_sources.in ; then
			rm -- ./target/lib_sources.in
		fi
		if test ! -e ./target/lib_sources.files ; then
			mkdir -- ./target/lib_sources.files
		fi
		(
			printf -- '%s\n' 'static SOURCES : &'\''static [((&'\''static str, usize), &'\''static str)] = &['
			find ./sources/ -xdev -type f -not -name '.*' -not -name 'lib_sources.in' \( -name '*.rs' -o -name '*.in' \) -printf '%f\n' \
			| LC_ALL=C sort \
			| while read _file ; do
				if test ! -e "./target/lib_sources.files/${_file}" -o "./sources/${_file}" -nt "./target/lib_sources.files/${_file}" ; then
					(
						printf -- '\n\n'
						readarray -t _file_lines < <( exec -- jq -R '.' < "./sources/${_file}" )
						_lines_count="${#_file_lines[@]}"
						for (( _line_index = 0 ; _line_index < _lines_count ; _line_index += 1 )) ; do
							printf '(("%s", %d), %s),\n' "${_file}" "$(( _line_index + 1 ))" "${_file_lines[$_line_index]}"
						done
						printf -- '\n\n'
					) > "./target/lib_sources.files/${_file}.tmp"
					mv -T -- "./target/lib_sources.files/${_file}.tmp" "./target/lib_sources.files/${_file}"
				fi
				cat -- "./target/lib_sources.files/${_file}"
			done
			printf -- '];\n'
		) >| ./target/.lib_sources.in.tmp
		touch -d "@${_timestamp_current}" -- ./target/.lib_sources.in.tmp
		mv -T -- ./target/.lib_sources.in.tmp ./target/lib_sources.in
	fi
!!

<< compile / lib / source
	test "${#}" -eq 0
	x-run ':: compile / lib / debug'
	export -- PATH="${RUST_PATH}"
	rustc \
			-Z unstable-options \
			--pretty=expanded \
			-- ./sources/lib.rs \
	| x-run ':: execute / rust-fmt'
!!

<< compile / test / scheme / source
	test "${#}" -eq 0
	x-run ':: compile / lib / debug'
	export -- PATH="${RUST_PATH}"
	rustc \
			--test \
			--extern vonuvoli_scheme=./target/debug/libvonuvoli_scheme.rlib \
			-Z unstable-options \
			--pretty=expanded \
			-- ./tests/scheme.rs \
	| x-run ':: execute / rust-fmt'
!!

<< execute / rust-fmt
	export -- PATH="${RUST_PATH}"
	( rustfmt --force "${@}" 2> /dev/null || true ) \
	| sed -r -n \
			-e ': b' \
			-e '/^$/ d' \
			-e '/^\#\[macro_use\]$/ d' \
			-e '/^\#\[macro_export\]$/ d' \
			-e '/^\#\[allow\(unused_macros\)\]$/ d' \
			-e '/^macro_rules!/ b d' \
			-e 'p' \
			-e 'b' \
			-e ': d' -e 'n' -e '/^ +/! b b' -e 'b d' \
	#
!!




:: execute / bin / interpreter / debug :: x-run ':: compile / bin / interpreter / debug' ; exec -- ./target/debug/vonuvoli-scheme-interpreter "${@}"
:: execute / bin / interpreter / release :: x-run ':: compile / bin / interpreter / release' ; exec -- ./target/release/vonuvoli-scheme-interpreter "${@}"

:: execute / bin / compiler / debug :: x-run ':: compile / bin / compiler / debug' ; exec -- ./target/debug/vonuvoli-scheme-compiler "${@}"
:: execute / bin / compiler / release :: x-run ':: compile / bin / compiler / release' ; exec -- ./target/release/vonuvoli-scheme-compiler "${@}"

:: execute / bin / tester / debug :: x-run ':: compile / bin / tester / debug' ; exec -- ./target/debug/vonuvoli-scheme-tester "${@}"
:: execute / bin / tester / release :: x-run ':: compile / bin / tester / release' ; exec -- ./target/release/vonuvoli-scheme-tester "${@}"

:: execute / bin / bencher / debug :: x-run ':: compile / bin / bencher / debug' ; exec -- ./target/debug/vonuvoli-scheme-bencher "${@}"
:: execute / bin / bencher / release :: x-run ':: compile / bin / bencher / release' ; exec -- ./target/release/vonuvoli-scheme-bencher "${@}"

:: execute / test / all / debug :: x-run ':: compile / test / all / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --no-default-features --features vonuvoli_debug --jobs 1 -- --test-threads 1 --test 'test__' "${@}"
:: execute / test / all / release :: x-run ':: compile / test / all / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --release --jobs 1 -- --test-threads 1 --test 'test__' "${@}"

:: execute / test / all / benchmark :: x-run ':: compile / test / all / release' ; exec -- taskset -c 2 env PATH="${RUST_PATH}" cargo test --quiet --release --jobs 1 -- --test-threads 1 --bench 'benchmark__' "${@}"
:: execute / test / all / coverage / kcov :: x-run ':: compile / test / all / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo kcov --no-clean-rebuild --no-default-features --features vonuvoli_debug --jobs 1 --output ./target/kcov -- "${@}"


:: execute / chibi :: exec -- chibi-scheme -m scheme.base -m scheme.case-lambda -m scheme.char -m scheme.complex -m scheme.cxr -m scheme.eval -m scheme.file -m scheme.inexact -m scheme.lazy -m scheme.load -m scheme.process-context -m scheme.r5rs -m scheme.read -m scheme.repl -m scheme.time -m scheme.write "${@}"
:: execute / gauche :: exec -- gosh -b -q -u scheme.base -u scheme.case-lambda -u scheme.char -u scheme.complex -u scheme.cxr -u scheme.eval -u scheme.file -u scheme.inexact -u scheme.lazy -u scheme.load -u scheme.process-context -u scheme.r5rs -u scheme.read -u scheme.repl -u scheme.time -u scheme.write "${@}"
:: execute / python :: exec -- python2 -E -O -O -B -u "${@}"




:: execute / bin / interpreter / debug / time :: x-run ':: compile / bin / interpreter / debug' ; exec --  time -f '(( elapsed: %E (user: %U, kernel: %S), CPU: %P, memory: %M (faults: %F, swapped: %W), I/O: %I / %O (waits: %w) ))' -- ./target/debug/vonuvoli-scheme-interpreter "${@}"
:: execute / bin / interpreter / release / time :: x-run ':: compile / bin / interpreter / release' ; exec --  time -f '(( elapsed: %E (user: %U, kernel: %S), CPU: %P, memory: %M (faults: %F, swapped: %W), I/O: %I / %O (waits: %w) ))' -- ./target/release/vonuvoli-scheme-interpreter "${@}"

:: execute / chibi / time :: exec -- time -f '(( elapsed: %E (user: %U, kernel: %S), CPU: %P, memory: %M (faults: %F, swapped: %W), I/O: %I / %O (waits: %w) ))' -- chibi-scheme -m scheme.base -m scheme.case-lambda -m scheme.char -m scheme.complex -m scheme.cxr -m scheme.eval -m scheme.file -m scheme.inexact -m scheme.lazy -m scheme.load -m scheme.process-context -m scheme.r5rs -m scheme.read -m scheme.repl -m scheme.time -m scheme.write "${@}"
:: execute / gauche / time :: exec -- time -f '(( elapsed: %E (user: %U, kernel: %S), CPU: %P, memory: %M (faults: %F, swapped: %W), I/O: %I / %O (waits: %w) ))' -- gosh -b -q -u scheme.base -u scheme.case-lambda -u scheme.char -u scheme.complex -u scheme.cxr -u scheme.eval -u scheme.file -u scheme.inexact -u scheme.lazy -u scheme.load -u scheme.process-context -u scheme.r5rs -u scheme.read -u scheme.repl -u scheme.time -u scheme.write "${@}"
:: execute / python / time :: exec -- time -f '(( elapsed: %E (user: %U, kernel: %S), CPU: %P, memory: %M (faults: %F, swapped: %W), I/O: %I / %O (waits: %w) ))' -- python2 -E -O -O -B -u "${@}"




:: execute / bin / interpreter / debug / x-selection / clipboard :: exec -- x-run ':: execute / bin / interpreter / debug' <( exec -- x-selection clipboard output )
:: execute / bin / interpreter / debug / x-selection / primary :: exec -- x-run ':: execute / bin / interpreter / debug' <( exec -- x-selection primary output )

:: execute / bin / compiler / debug / x-selection / clipboard :: exec -- less-exec x-run ':: execute / bin / compiler / debug' <( exec -- x-selection clipboard output )
:: execute / bin / compiler / debug / x-selection / primary :: exec -- less-exec x-run ':: execute / bin / compiler / debug' <( exec -- x-selection primary output )




:: compile / all / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / all / debug' "${@}"
:: compile / lib / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / lib / debug' "${@}"
:: compile / bin / interpreter / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / bin / interpreter / debug' "${@}"
:: compile / bin / compiler / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / bin / compiler / debug' "${@}"
:: compile / bin / tester / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / bin / tester / debug' "${@}"
:: compile / bin / bencher / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / bin / bencher / debug' "${@}"
:: compile / test / all / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / test / all / debug' "${@}"

:: execute / test / all / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / test / all / debug' "${@}"

:: execute / bin / interpreter / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / bin / interpreter / debug' "${@}"
:: execute / bin / compiler / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / bin / compiler / debug' "${@}"
:: execute / bin / tester / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / bin / tester / debug' "${@}"
:: execute / bin / bencher / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / bin / bencher / debug' "${@}"




<< execute / watch
	test "${#}" -ge 1
	while true ; do
		_timestamp_previous="$( find ./Cargo.toml ./Cargo.lock ./sources/ ./tests/ ./examples/ -xdev -type f -not -path '*/_outputs/*' -printf '%T+\n' | LC_ALL=C sort | tail -n 1 )"
		if ! "${@}" 2>&1 < /dev/null | tee "./target/x-run--watch--${$}.txt" ; then
			x-output osd-notify low "FAILED!  ${*}"
			less -- "./target/x-run--watch--${$}.txt"
		else
			x-output osd-notify low "Succeeded:  ${*}"
			rm -- "./target/x-run--watch--${$}.txt"
		fi
		printf '\n[--]\n' >&2
		while sleep 0.5s ; do
			_timestamp_current="$( find ./Cargo.toml ./Cargo.lock ./sources/ ./tests/ ./examples/ -xdev -type f -not -path '*/_outputs/*' -printf '%T+\n' | LC_ALL=C sort | tail -n 1 )"
			if test "${_timestamp_previous}" != "${_timestamp_current}" ; then
				break
			fi
		done
		printf '\n[--]\n\n' >&2
	done
!!




:: browse / doc :: exec -- x-www open file://"$( readlink -e -- ./target/doc/vonuvoli_scheme/index.html )"
:: browse / coverage / kcov :: exec -- x-www open file://"$( readlink -e -- ./target/kcov/index.html )"
:: browse / r7rs :: exec -- x-www open file://"$( readlink -e -- ./documentation/external/r7rs-small-spec/stripped/r7rs.pdf )"
:: browse / documentation / readme :: exec -- x-www open http://127.0.0.1:53110/




:: files / grep / sources / string :: exec -- git grep --no-index -C10 -F "${@/#/-e}" -- ./sources
:: files / grep / sources / regexp :: exec -- git grep --no-index -C10 -P "${@/#/-e}" -- ./sources

:: files / grep / sources / x-selection / primary :: exec -- git grep --no-index -C10 -F -e "$( exec -- x-selection primary output )" -- ./sources
:: files / grep / sources / x-selection / clipboard :: exec -- git grep --no-index -C10 -F -e "$( exec -- x-selection clipboard output )" -- ./sources

:: files / grep / sources / fixme / show :: exec -- git grep --no-index -C10 -P -e 'FIXME' -- ./sources
:: files / grep / sources / fixme / list :: exec -- git grep --no-index -l -P -e 'FIXME' -- ./sources

:: files / grep / sources / todo / show :: exec -- git grep --no-index -C10 -P -e 'TODO' -- ./sources
:: files / grep / sources / todo / list :: exec -- git grep --no-index -l -P -e 'TODO' -- ./sources

:: files / grep / sources / unimplemented / all / show :: exec -- git grep --no-index -C10 -P -e 'unimplemented!(?!.*// (deferred|OK)$)' -- ./sources
:: files / grep / sources / unimplemented / all / list :: exec -- git grep --no-index -l -P -e 'unimplemented!(?!.*// (deferred|OK)$)' -- ./sources
:: files / grep / sources / unimplemented / primitives / show :: exec -- git grep --no-index -C10 -P -e 'unimplemented!(?!.*// (deferred|OK)$)' -- './sources/primitives*.rs'
:: files / grep / sources / unimplemented / builtins / show :: exec -- git grep --no-index -C10 -P -e 'unimplemented!(?!.*// (deferred|OK)$)' -- './sources/builtins*.rs'

:: files / grep / sources / errors / duplicates / list :: grep -o -P -e '(?<=0x)[0-9a-f]{8}(?=[)])|(?<=")[0-9a-f]{8}(?=")' -h -r ./sources -r ./tests --include '*.rs' --include '*.in' | sort | uniq -d
:: files / grep / sources / errors / duplicates / show :: x-run ':: files / grep / sources / errors / duplicates / list' | git grep --no-index -C0 -F -f /dev/stdin -- ./sources ./tests
:: files / grep / sources / errors / improper / list :: grep -o -P -e '(?<=0x)([0-9a-f]{3,7}|[0-9a-f]{9,})(?=[)])|(?<=")([0-9a-f]{3,7}|[0-9a-f]{9,})(?=")' -h -r ./sources -r ./tests --include '*.rs' --include '*.in' | sort -u
:: files / grep / sources / errors / improper / show :: x-run ':: files / grep / sources / errors / improper / list' | git grep --no-index -C2 -F -f /dev/stdin -- ./sources ./tests

:: files / sed / sources / inline-always / disable :: exec -- find ./sources ./tests -xdev -type f \( -name '*.rs' -o -name '*.in' \) -exec sed -r -e 's!^(\s*)(#\[ inline \(always\) \])$!\1#[ inline (never) ] // __inline_always__!' -i -- {} \;
:: files / sed / sources / inline-always / enable :: exec -- find ./sources ./tests -xdev -type f \( -name '*.rs' -o -name '*.in' \) -exec sed -r -e 's!^(\s*)(#\[ inline \(never\) \] // __inline_always__)$!\1#[ inline (always) ]!' -i -- {} \;
:: files / sed / sources / inline-always / configurable :: exec -- find ./sources ./tests -xdev -type f \( -name '*.rs' -o -name '*.in' \) -exec sed -r -e 's!^(\s*)(#\[ inline \(always\) \])$!\1#[ cfg_attr ( feature = "vonuvoli_inline", inline (always) ) ]!' -i -- {} \;
:: files / sed / sources / inline-always / to-plain :: exec -- find ./sources ./tests -xdev -type f \( -name '*.rs' -o -name '*.in' \) -exec sed -r -e 's!^(\s*)(#\[ inline \(always\) \])$!\1#[ inline ]!' -e 's!^(\s*)(#\[ cfg_attr \( feature = "vonuvoli_inline", inline \(always\) \) \])$!\1#[ cfg_attr ( feature = "vonuvoli_inline", inline ) ]!' -i -- {} \;

:: files / grep / outputs / benchmarks :: git diff --color-words -U0 -- ./tests/_outputs/*--benchmark__* | grep -E -e '^....--' -e 'average' | sed -r -e 's/^(....)--- i\/tests\/_outputs\/[a-z0-9-]+--benchmark__/\1/'




<< workbench / rust-up / initialize
	test "${#}" -eq 0
	test ! -e ./.rust/.initialized
	test -e ./.rust
	mkdir -- ./.rust/rustup
	mkdir -- ./.rust/cargo
	curl -s -o ./.rust/rustup-init.tmp -- https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init
	chmod +x -- ./.rust/rustup-init.tmp
	mv -n -T -- ./.rust/rustup-init.tmp ./.rust/rustup-init
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	nice -n 19 -- ./.rust/rustup-init -y --no-modify-path
	touch -- ./.rust/.initialized
!!

<< workbench / rust-up / install
	test "${#}" -eq 0
	test -e ./.rust/.initialized
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	nice -n 19 -- ./.rust/cargo/bin/rustup install stable
	nice -n 19 -- ./.rust/cargo/bin/rustup install nightly
!!

<< workbench / rust-up / upgrade
	test "${#}" -eq 0
	test -e ./.rust/.initialized
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	nice -n 19 -- ./.rust/cargo/bin/rustup update
!!

<< workbench / cargo / install or upgrade
	test "${#}" -eq 0
	test -e ./.rust/.initialized
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	export -- PATH="${RUST_PATH}"
	nice -n 19 -- cargo install --force cargo-kcov
	nice -n 19 -- cargo install --force rustfmt
	# nice -n 19 -- cargo install --force rustfmt-nightly
	nice -n 19 -- cargo install --force peg
!!

<< workbench / cargo / update
	test "${#}" -eq 0
	test -e ./.rust/.initialized
	export -- RUSTUP_HOME="$( exec -- readlink -e -- ./.rust/rustup )"
	export -- CARGO_HOME="$( exec -- readlink -e -- ./.rust/cargo )"
	export -- PATH="${RUST_PATH}"
	nice -n 19 -- cargo update
!!

<< workbench / python / initialize
	test "${#}" -eq 0
	test ! -e ./.python/.initialized
	test -e ./.python
	nice -n 19 -- virtualenv --python python2.7 -- ./.python
	touch -- ./.python/.initialized
!!

<< workbench / python / install or upgrade
	test "${#}" -eq 0
	test -e ./.python/.initialized
	# nice -n 19 -- ./.python/bin/pip install --force docutils
	nice -n 19 -- ./.python/bin/pip install --force restview
!!

:: environment / rust-up / use / stable :: export -- RUST_PATH="$( exec -- readlink -e -- ./.rust/rustup/toolchains/stable-x86_64-unknown-linux-gnu/bin ):$( exec -- readlink -e -- ./.rust/cargo/bin ):${PATH}"
:: environment / rust-up / use / nightly :: export -- RUST_PATH="$( exec -- readlink -e -- ./.rust/rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin ):$( exec -- readlink -e -- ./.rust/cargo/bin ):${PATH}"

:: environment / rust / stack / 128M :: export -- RUST_MIN_STACK=134217728
:: environment / rust / stack / 1024M :: export -- RUST_MIN_STACK=1073741824
:: environment / rust / backtrace / enable :: export -- RUST_BACKTRACE=1
:: environment / rust / backtrace / disable :: export -- RUST_BACKTRACE=0

:: environment / tests / debug / enable :: export -- VONUVOLI_SCHEME_TESTS_DEBUG=true
:: environment / tests / debug / disable :: export -- VONUVOLI_SCHEME_TESTS_DEBUG=false

:: environment / x-run / trace / enable :: export -- X_RUN_TRACE=true
:: environment / x-run / trace / disable :: export -- X_RUN_TRACE=false

:: environment / taskset / all :: exec -- taskset -a -p -c 0-31 "${$}"
:: environment / taskset / 0,2 :: exec -- taskset -a -p -c 0,2 "${$}"
:: environment / taskset / 3 :: exec -- taskset -a -p -c 3 "${$}"

EOS




find ./ -xdev -type f \
		\( -path './sources/*' -o -path './tests/*' \) \
		\( -name '*.rs' -o -name '*.in' -o -name '*.ss' -o -name '*.sst' \) \
		-printf ':: files / edit / %P :: exec -- sce %p\n' \
		-printf ':: files / view / %P :: exec -- less -- %p\n' \
| sort




for _test in scheme builtins-lists low-level-r7rs low-level-parser low-level-sizes low-level-assertions low-level-rust ; do
test -f "./tests/${_test}.rs"
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' <<'EOS'
:: compile / test / @{TEST} / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: compile / test / @{TEST} / debug' "${@}"
:: compile / test / @{TEST} / debug :: x-run ':: compile / lib / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --test '@{TEST}' --no-default-features --features vonuvoli_debug
:: compile / test / @{TEST} / release :: x-run ':: compile / lib / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo build --quiet --test '@{TEST}' --release
:: execute / test / @{TEST} / tests / all / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / test / @{TEST} / tests / all / debug' "${@}"
:: execute / test / @{TEST} / tests / all / debug :: x-run ':: compile / test / @{TEST} / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --test '@{TEST}' --no-default-features --features vonuvoli_debug --jobs 1 -- --nocapture --test-threads 1 --test 'test__' "${@}"
:: execute / test / @{TEST} / tests / all / release :: x-run ':: compile / test / @{TEST} / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --test '@{TEST}' --release --jobs 1 -- --nocapture --test-threads 1 --test 'test__' "${@}"
:: execute / test / @{TEST} / benchmarks / all / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / test / @{TEST} / benchmarks / all / debug' "${@}"
:: execute / test / @{TEST} / benchmarks / all / debug :: x-run ':: compile / test / @{TEST} / debug' ; exec -- taskset -c 2 env PATH="${RUST_PATH}" cargo test --quiet --test '@{TEST}' --no-default-features --features vonuvoli_debug --jobs 1 -- --nocapture --test-threads 1 --bench 'benchmark__' "${@}"
:: execute / test / @{TEST} / benchmarks / all / release :: x-run ':: compile / test / @{TEST} / release' ; exec -- taskset -c 2 env PATH="${RUST_PATH}" VONUVOLI_SCHEME_BENCHMARKS_OUTPUT='./tests/_outputs/@{TEST}--{IDENTIFIER}.out' cargo test --quiet --test '@{TEST}' --release --jobs 1 -- --nocapture --test-threads 1 --bench 'benchmark__' "${@}"
:: execute / test / @{TEST} / coverage / all / kcov :: x-run ':: compile / test / @{TEST} / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo kcov --test '@{TEST}' --no-clean-rebuild --no-default-features --features vonuvoli_debug --jobs 1 --output ./target/kcov -- "${@}"
:: execute / test / @{TEST} / coverage / all / kcov / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / test / @{TEST} / coverage / all / kcov'
EOS
done


find ./tests/scheme -xdev -type f -name '*.sst' -printf '%f\n' \
| sed -r -e 's/\.sst$//' -e 's/-/_/g' \
| sort -u \
| while read _test ; do
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' <<'EOS'
:: execute / test / scheme / tests / @{TEST} / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / test / scheme / @{TEST} / debug' "${@}"
:: execute / test / scheme / tests / @{TEST} / debug :: x-run ':: compile / test / scheme / debug' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --test scheme --no-default-features --features vonuvoli_debug --jobs 1 -- --nocapture --test-threads 1 --test 'test__@{TEST}' --exact "${@}"
:: execute / test / scheme / tests / @{TEST} / release :: x-run ':: compile / test / scheme / release' ; exec -- nice -n 19 -- env PATH="${RUST_PATH}" cargo test --quiet --test scheme --release --jobs 1 -- --nocapture --test-threads 1 --test 'test__@{TEST}' --exact "${@}"
:: execute / test / scheme / benchmarks / @{TEST} / debug :: x-run ':: compile / test / scheme / debug' ; exec -- taskset -c 2 env PATH="${RUST_PATH}" cargo test --quiet --test scheme --no-default-features --features vonuvoli_debug --jobs 1 -- --nocapture --test-threads 1 --bench 'benchmark__@{TEST}' --exact "${@}"
:: execute / test / scheme / benchmarks / @{TEST} / release :: x-run ':: compile / test / scheme / release' ; exec -- taskset -c 2 env PATH="${RUST_PATH}" VONUVOLI_SCHEME_BENCHMARKS_OUTPUT='./tests/_outputs/scheme--{IDENTIFIER}.out' cargo test --quiet --test scheme --release --jobs 1 -- --nocapture --test-threads 1 --bench 'benchmark__@{TEST}' --exact "${@}"
EOS
done


find ./tests/scheme -xdev -type f -name '*.sst' -printf '%f\n' \
| sed -r -e 's/\.sst$//' \
| sort -u \
| while read _test ; do
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' -e 's#\{IDENTIFIER\}'#"${_test//-/_}"'#g' <<'EOS'
:: execute / bin / tester / @{TEST} / debug / watch :: exec -- x-run ':: execute / watch' x-run ':: execute / bin / tester / @{TEST} / debug'
:: execute / bin / tester / @{TEST} / debug :: exec -- nice -n 19 -- x-run ':: execute / bin / tester / debug' './tests/scheme/@{TEST}.sst' "${@}"
:: execute / bin / tester / @{TEST} / release :: exec -- nice -n 19 -- x-run ':: execute / bin / tester / release' './tests/scheme/@{TEST}.sst' "${@}"
:: execute / bin / bencher / @{TEST} / debug :: exec -- taskset -c 2 x-run ':: execute / bin / bencher / debug' './tests/scheme/@{TEST}.sst' "${@}"
:: execute / bin / bencher / @{TEST} / release :: exec -- taskset -c 2 env VONUVOLI_SCHEME_BENCHMARKS_OUTPUT='./tests/_outputs/scheme--benchmark__{IDENTIFIER}.out' x-run ':: execute / bin / bencher / release' './tests/scheme/@{TEST}.sst' "${@}"
EOS
done


printf -- '%s\n' '<< execute / bin / tester / all / debug'
printf -- '%s\n' "x-run ':: compile / bin / tester / debug'"
find ./tests/scheme -xdev -type f -name '*.sst' -printf '%f\n' \
| sed -r -e 's/\.sst$//' \
| sort -u \
| while read _test ; do
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' -e 's#\{IDENTIFIER\}'#"${_test//-/_}"'#g' <<'EOS'
nice -n 19 -- ./target/debug/vonuvoli-scheme-tester './tests/scheme/@{TEST}.sst' "${@}"
EOS
done
printf -- '%s\n' '!!'


printf -- '%s\n' '<< execute / bin / bencher / all / release'
printf -- '%s\n' "x-run ':: compile / bin / bencher / release'"
find ./tests/scheme -xdev -type f -name '*.sst' -printf '%f\n' \
| sed -r -e 's/\.sst$//' \
| sort -u \
| while read _test ; do
sed -r -e 's#@\{TEST\}#'"${_test}"'#g' -e 's#\{IDENTIFIER\}'#"${_test//-/_}"'#g' <<'EOS'
if test './tests/scheme/@{TEST}.sst' -nt './tests/_outputs/scheme--benchmark__{IDENTIFIER}.out' ; then taskset -c 2 env VONUVOLI_SCHEME_BENCHMARKS_OUTPUT='./tests/_outputs/scheme--benchmark__{IDENTIFIER}.out' ./target/release/vonuvoli-scheme-bencher './tests/scheme/@{TEST}.sst' "${@}" ; fi
EOS
done
printf -- '%s\n' '!!'


find ./examples -xdev -type f -name 'benchmark--*.ss' -printf '%f\n' \
| sed -r -e 's/^benchmark--//' -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
:: execute / bin / compiler / benchmarks / @{SCRIPT} / debug :: x-run ':: execute / bin / compiler / debug' './examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null >| './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-compile.out'
:: execute / bin / compiler / benchmarks / @{SCRIPT} / release :: x-run ':: execute / bin / compiler / release' ./examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null >| './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-compile.out'
:: execute / benchmark / vonuvoli / benchmarks / @{SCRIPT} / debug :: taskset -c 2 x-run ':: execute / bin / interpreter / debug' './examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null | tee -- './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-debug.out'
:: execute / benchmark / vonuvoli / benchmarks / @{SCRIPT} / release :: taskset -c 2 x-run ':: execute / bin / interpreter / release' './examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null | tee -- './examples/_outputs/benchmark--@{SCRIPT}--vonuvoli-release.out'
:: execute / benchmark / chibi / benchmarks / @{SCRIPT} :: taskset -c 2 x-run ':: execute / chibi' -- './examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null | tee -- './examples/_outputs/benchmark--@{SCRIPT}--chibi.out'
:: execute / benchmark / gauche / benchmarks / @{SCRIPT} :: taskset -c 2 x-run ':: execute / gauche' -- './examples/benchmark--@{SCRIPT}.ss' "${@}" < /dev/null | tee -- './examples/_outputs/benchmark--@{SCRIPT}--gauche.out'
EOS
done


find ./examples -xdev -type f -name 'benchmark--*.py' -printf '%f\n' \
| sed -r -e 's/^benchmark--//' -e 's/\.py$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
:: execute / benchmark / python / benchmarks / @{SCRIPT} :: taskset -c 2 x-run ':: execute / python' -- './examples/benchmark--@{SCRIPT}.py' "${@}" < /dev/null | tee -- './examples/_outputs/benchmark--@{SCRIPT}--python.out'
EOS
done


find ./examples -xdev -type f \( -name 'benchmark--*.ss' -o -name 'benchmark--*.py' \) -printf '%f\n' \
| sed -r -e 's/^benchmark--//' -e 's/\.ss$//' -e 's/\.py$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
<< execute / benchmark / compare / benchmarks / @{SCRIPT}
	printf -- '\n--------------------------------------------------------------------------------\n' >&2
	printf -- '\n== %s / vonuvoli / release ==\n' '@{SCRIPT}' >&2
	x-run ':: execute / benchmark / vonuvoli / benchmarks / @{SCRIPT} / release'
	printf -- '\n== %s / chibi ==\n' '@{SCRIPT}' >&2
	x-run ':: execute / benchmark / chibi / benchmarks / @{SCRIPT}'
	printf -- '\n== %s / gauche ==\n' '@{SCRIPT}' >&2
	x-run ':: execute / benchmark / gauche / benchmarks / @{SCRIPT}'
	if test -e './examples/benchmark--@{SCRIPT}.py' ; then
		printf -- '\n== %s / python ==\n' '@{SCRIPT}' >&2
		x-run ':: execute / benchmark / python / benchmarks / @{SCRIPT}'
	fi
	printf -- '\n--------------------------------------------------------------------------------\n' >&2
!!
EOS
done


printf -- '%s\n' '<< execute / benchmark / compare / all'
find ./examples -xdev -type f -name 'benchmark--*.ss' -printf '%f\n' \
| sed -r -e 's/^benchmark--//' -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
printf -- '%s\n' "x-run ':: execute / benchmark / compare / ${_script}'"
done
printf -- '%s\n' '!!'


printf -- '%s\n' '<< execute / benchmark / vonuvoli / all / release'
find ./examples -xdev -type f -name 'benchmark--*.ss' -printf '%f\n' \
| sed -r -e 's/^benchmark--//' -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
printf -- '%s\n' "x-run ':: execute / benchmark / vonuvoli / ${_script} / release'"
done
printf -- '%s\n' '!!'


find ./examples -xdev -type f -name 'optimizer--*.ss' -printf '%f\n' \
| sed -r -e 's/^optimizer--//' -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
:: execute / bin / compiler / optimizations / @{SCRIPT} / debug :: nice -n 19 -- x-run ':: execute / bin / compiler / debug' './examples/optimizer--@{SCRIPT}.ss' "${@}" >| './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out'
:: execute / bin / compiler / optimizations / @{SCRIPT} / release :: nice -n 19 -- x-run ':: execute / bin / compiler / release' './examples/optimizer--@{SCRIPT}.ss' "${@}" >| './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out'
EOS
done


printf -- '%s\n' '<< execute / bin / compiler / all / debug'
printf -- '%s\n' "x-run ':: compile / bin / compiler / debug'"
find ./examples -xdev -type f \( -name 'optimizer--*.ss' -o -name 'benchmark--*.ss' -o -name 'examples--*.ss' \) -printf '%f\n' \
| sed -r -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
nice -n 19 -- ./target/debug/vonuvoli-scheme-compiler './examples/@{SCRIPT}.ss' "${@}" >| './examples/_outputs/@{SCRIPT}--vonuvoli-compile.out'
EOS
done
printf -- '%s\n' '!!'




find ./examples -xdev -type f -name 'examples--*.ss' -printf '%f\n' \
| sed -r -e 's/^examples--//' -e 's/\.ss$//' \
| sort -u \
| while read _script ; do
sed -r -e 's#@\{SCRIPT\}#'"${_script}"'#g' <<'EOS'
:: execute / bin / interpreter / examples / @{SCRIPT} / debug / watch :: exec -- x-run ':: execute / bin / interpreter / debug / watch' './examples/examples--@{SCRIPT}.ss' "${@}"
:: execute / bin / interpreter / examples / @{SCRIPT} / debug :: exec -- x-run ':: execute / bin / interpreter / debug' './examples/examples--@{SCRIPT}.ss' "${@}"
:: execute / bin / interpreter / examples / @{SCRIPT} / release :: exec -- x-run ':: execute / bin / interpreter / release' './examples/examples--@{SCRIPT}.ss' "${@}"
:: execute / bin / compiler / examples / @{SCRIPT} / debug :: nice -n 19 -- x-run ':: execute / bin / compiler / debug' './examples/examples--@{SCRIPT}.ss' "${@}" >| './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/examples--@{SCRIPT}--vonuvoli-compile.out'
:: execute / bin / compiler / examples / @{SCRIPT} / release :: nice -n 19 -- x-run ':: execute / bin / compiler / release' './examples/examples--@{SCRIPT}.ss' "${@}" >| './examples/_outputs/optimizer--@{SCRIPT}--vonuvoli-compile.out' ; exec -- less -- './examples/_outputs/examples--@{SCRIPT}--vonuvoli-compile.out'
EOS
done




if true ; then
	exec 1>&"${_stdout_fd}"-
	X_RUN_ACTION=parse x-run < ./.x-run.options.tmp1 >| ./.x-run.options.tmp2
	mv -T -- ./.x-run.options.tmp2 ./.x-run.options
	rm -- ./.x-run.options.tmp1
	exec cat -- ./.x-run.options
	exit -- 1
fi

exit -- 0

